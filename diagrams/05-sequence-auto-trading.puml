@startuml Sequence Diagram - Auto Trading
title 자동매매 실행 플로우

participant "Scheduler" as scheduler
participant "Strategy Manager" as strategyManager
participant "Signal Generator" as signalGenerator
participant "Risk Manager" as riskManager
participant "Order Executor" as orderExecutor
participant "KIS API Service" as kisService
participant "한국투자증권 API" as kisAPI
participant "Database" as db
participant "WebSocket Server" as ws
participant "Web App" as web

== 스케줄러 트리거 (예: 매 1분) ==
scheduler -> strategyManager: 활성화된 전략 실행

activate strategyManager
strategyManager -> db: 활성화된 전략 목록 조회
activate db
db --> strategyManager: Strategy[]
deactivate db

loop 각 전략마다
    strategyManager -> signalGenerator: 신호 생성 요청\n(strategy, market_data)
    activate signalGenerator

    signalGenerator -> db: 최근 시장 데이터 조회
    activate db
    db --> signalGenerator: Market Data
    deactivate db

    signalGenerator -> signalGenerator: 전략 로직 실행\n- 기술적 지표 계산\n- 매매 조건 검증

    alt 매수/매도 신호 발생
        signalGenerator -> db: 신호 저장
        activate db
        db --> signalGenerator: Signal ID
        deactivate db

        signalGenerator --> strategyManager: Signal (BUY/SELL)
        deactivate signalGenerator

        strategyManager -> riskManager: 리스크 검증\n(signal, portfolio, limits)
        activate riskManager

        riskManager -> db: 계좌 정보 및 보유 종목 조회
        activate db
        db --> riskManager: Account, Holdings
        deactivate db

        riskManager -> riskManager: 리스크 체크\n- 일일 거래 횟수\n- 일일 손실 한도\n- 포지션 크기\n- 종목 분산

        alt 리스크 검증 통과
            riskManager --> strategyManager: OK
            deactivate riskManager

            strategyManager -> orderExecutor: 주문 실행\n(signal, quantity, price)
            activate orderExecutor

            orderExecutor -> db: 주문 정보 저장 (status: pending)
            activate db
            db --> orderExecutor: Order ID
            deactivate db

            orderExecutor -> kisService: 주문 요청
            activate kisService
            kisService -> kisAPI: POST /uapi/domestic-stock/v1/trading/order-cash
            activate kisAPI
            kisAPI --> kisService: 주문 접수 응답
            deactivate kisAPI

            kisService --> orderExecutor: 주문 접수 완료
            deactivate kisService

            orderExecutor -> db: 주문 상태 업데이트\n(status: submitted)
            activate db
            db --> orderExecutor: OK
            deactivate db

            orderExecutor -> ws: 주문 알림 전송
            activate ws
            ws -> web: WebSocket Push\n"주문 접수: {symbol} {side}"
            deactivate ws

            orderExecutor --> strategyManager: 주문 완료
            deactivate orderExecutor

        else 리스크 검증 실패
            riskManager --> strategyManager: 리스크 검증 실패
            deactivate riskManager

            strategyManager -> db: 신호 상태 업데이트\n(rejected: true)
            activate db
            db --> strategyManager: OK
            deactivate db

            strategyManager -> ws: 리스크 경고 알림
            activate ws
            ws -> web: WebSocket Push\n"리스크 한도 초과"
            deactivate ws
        end

    else 신호 없음 (HOLD)
        signalGenerator --> strategyManager: No Signal
        deactivate signalGenerator
    end
end

deactivate strategyManager

== 체결 확인 (별도 프로세스) ==
scheduler -> orderExecutor: 미체결 주문 확인
activate orderExecutor

orderExecutor -> db: 미체결 주문 조회
activate db
db --> orderExecutor: Pending Orders
deactivate db

loop 각 미체결 주문
    orderExecutor -> kisService: 체결 확인
    activate kisService
    kisService -> kisAPI: GET /uapi/domestic-stock/v1/trading/inquire-order
    activate kisAPI
    kisAPI --> kisService: 체결 정보
    deactivate kisAPI
    kisService --> orderExecutor: 체결 결과
    deactivate kisService

    alt 체결 완료
        orderExecutor -> db: 주문 상태 업데이트 (status: filled)\n거래 기록 생성 (trades)
        activate db
        db --> orderExecutor: OK
        deactivate db

        orderExecutor -> db: 보유 종목 업데이트 (holdings)
        activate db
        db --> orderExecutor: OK
        deactivate db

        orderExecutor -> ws: 체결 알림
        activate ws
        ws -> web: WebSocket Push\n"체결 완료: {symbol} {quantity}주 @ {price}"
        deactivate ws
    end
end

deactivate orderExecutor

@enduml
